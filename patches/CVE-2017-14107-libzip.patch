From a5fc6f13f2a92d603e442302d0cb561517cd693c Mon Sep 17 00:00:00 2001
From: jjergus <jjergus@fb.com>
Date: Mon, 11 Nov 2019 14:40:42 -0800
Subject: [PATCH] libzip CVE-2017-14107

---
 lib/zip_open.c | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/third-party/libzip/src/lib/zip_open.c b/third-party/libzip/src/lib/zip_open.c
index d6209ee1..29409b74 100644
--- a/third-party/libzip/src/lib/zip_open.c
+++ b/third-party/libzip/src/lib/zip_open.c
@@ -837,7 +837,12 @@ _zip_read_eocd64(zip_source_t *src, zip_buffer_t *buffer, zip_uint64_t buf_offse
         zip_error_set(error, ZIP_ER_SEEK, EFBIG);
         return NULL;
     }
-    if ((flags & ZIP_CHECKCONS) && offset+size != eocd_offset) {
+    if (offset+size > buf_offset + eocd_offset) {
+	/* cdir spans past EOCD record */
+	zip_error_set(error, ZIP_ER_INCONS, 0);
+	return NULL;
+    }
+    if ((flags & ZIP_CHECKCONS) && offset+size != buf_offset + eocd_offset) {
 	zip_error_set(error, ZIP_ER_INCONS, 0);
 	return NULL;
     }
-- 
2.17.1
